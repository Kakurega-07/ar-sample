<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>å¯Œå£«å±±AR</title>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
<style>
  #info {
    position: fixed;
    top: 10px;
    left: 10px;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 15px;
    font-family: sans-serif;
    font-size: 14px;
    z-index: 9999;
    border-radius: 5px;
    max-width: 80%;
  }
</style>
</head>
<body style="margin: 0; overflow: hidden;">

<div id="info">
   å¯Œå£«å±±AR<br>
   ä½ç½®æƒ…å ±å–å¾—ä¸­...
</div>

<a-scene 
    id="ar-scene"
    vr-mode-ui="enabled: false" 
    renderer="logarithmicDepthBuffer: true"
    arjs='sourceType: webcam; 
          sourceWidth:1280; sourceHeight:960; 
          displayWidth: 1280; displayHeight: 960;
          debugUIEnabled: false;' 
    device-orientation-permission-ui 
    loading-screen="enabled: false"
    embedded>
    
    <a-assets>
        <img id="mountain-texture" src="https://cdn.glitch.global/c312fb27-4a00-47e0-945f-c07a3c7a2503/rock_texture.jpg?v=1700000000000">
        </a-assets>
    
    <a-entity light="type: ambient; color: #BBB; intensity: 0.9"></a-entity>
    <a-entity light="type: directional; color: #FFF; intensity: 0.7; castShadow: true" position="-1 2 1"></a-entity>
    <a-entity light="type: point; color: #ADD8E6; intensity: 0.3; castShadow: false" position="0 5 -10"></a-entity>

    <a-camera 
        id="camera"
        look-controls="enabled: true; magicWindowTrackingEnabled: true;"
        position="0 0 0">
    </a-camera>
    
    <a-entity id="fujisan-ar-container" position="0 0 0">
        <a-cone
            id="fuji-body"
            material="shader: standard; src: #mountain-texture; repeat: 8 8; roughness: 0.8; metalness: 0.1;" 
            radius-bottom="8"       radius-top="0.2"
            height="10"             segments-radial="64"    segments-height="16"    position="0 0 -50"      rotation="0 45 0"       shadow="receive: true; cast: true">
        </a-cone>
        
        <a-sphere
            id="fuji-snowcap"
            material="shader: standard; color: white; opacity: 0.8; roughness: 0.2; metalness: 0.1;" 
            radius="2.5"           position="0 9.5 -50"   segments-width="32"    segments-height="32"   geometry="theta-length: 70;" 
            rotation="0 0 0"
            shadow="receive: true; cast: true">
        </a-sphere>

        <a-text value="FUJI-SAN" 
                position="0 11 -50" 
                align="center" 
                color="#E54C3C" 
                scale="4 4 4">  </a-text>

    </a-entity>
    
</a-scene>

<script>
const infoDiv = document.getElementById('info');
const fujisanContainer = document.getElementById('fujisan-ar-container');
const fujiBody = document.getElementById('fuji-body');
const fujiSnowcap = document.getElementById('fuji-snowcap');
const fujiLabel = document.querySelector('a-text[value="FUJI-SAN"]');

// å¯Œå£«å±±ã®ç¾å®Ÿã®åº§æ¨™
const fujiLat = 35.360556; 
const fujiLon = 138.727778; 

let userLat = null; 
let userLon = null; 

// --- ã‚¸ã‚ªãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç®—é–¢æ•° (å¤‰æ›´ãªã—) ---
const R = 6371; // åœ°çƒã®åŠå¾„ (km)
function toRad(degrees) { return degrees * Math.PI / 180; }

function calcDistance(lat1, lon1, lat2, lon2) { 
    const dLat = toRad(lat2 - lat1); 
    const dLon = toRad(lon2 - lon1); 
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) + 
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
    return R * c; 
} 

function calcBearing(lat1, lon1, lat2, lon2) { 
    const dLon = toRad(lon2 - lon1); 
    const y = Math.sin(dLon) * Math.cos(toRad(lat2)); 
    const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) - 
              Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon); 
    const bearing = Math.atan2(y, x) * 180 / Math.PI; 
    return (bearing + 360) % 360; 
} 

function bearingToJapanese(bearing) { 
    const directions = ['åŒ—', 'åŒ—åŒ—æ±', 'åŒ—æ±', 'æ±åŒ—æ±', 'æ±', 'æ±å—æ±', 'å—æ±', 'å—å—æ±', 
                        'å—', 'å—å—è¥¿', 'å—è¥¿', 'è¥¿å—è¥¿', 'è¥¿', 'è¥¿åŒ—è¥¿', 'åŒ—è¥¿', 'åŒ—åŒ—è¥¿']; 
    const index = Math.round(bearing / 22.5) % 16; 
    return directions[index]; 
} 

function bearingToPosition(bearing, distance) { 
    const rad = toRad(bearing); 
    const x = Math.sin(rad) * distance;  // æ±è¥¿æ–¹å‘ 
    const z = -Math.cos(rad) * distance; // å—åŒ—æ–¹å‘ï¼ˆ-ZãŒåŒ—ï¼‰ 
    return { x, z }; 
} 

// --- å¯Œå£«å±±ã¨ã‚³ãƒ³ãƒ‘ã‚¹ã®ä½ç½®ã‚’æ›´æ–°ï¼ˆã‚¸ã‚ªãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ARã®è‚ï¼‰ ---
function updatePositions() { 
    if (userLat === null || userLon === null) {
        infoDiv.innerHTML = `
             <strong>å¯Œå£«å±±AR</strong><br>
             ä½ç½®æƒ…å ±å–å¾—ä¸­...<br><br>
             **ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚** ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚„ãƒ‡ãƒã‚¤ã‚¹ã®GPSã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚
        `;
        fujisanContainer.setAttribute('visible', false);
        return; 
    }
    
    fujisanContainer.setAttribute('visible', true);

    const bearing = calcBearing(userLat, userLon, fujiLat, fujiLon); 
    const distance = calcDistance(userLat, userLon, fujiLat, fujiLon); 
    const direction = bearingToJapanese(bearing); 
    
    // å¯Œå£«å±±ã®3Dãƒ¢ãƒ‡ãƒ«ã‚’é…ç½®ã™ã‚‹ARç©ºé–“ä¸Šã®è·é›¢
    // ã‚ˆã‚Šå¤§ããªãƒ¢ãƒ‡ãƒ«ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦ã€AR_DISTANCEã‚’å¤§ããèª¿æ•´
    const AR_DISTANCE = 50; 
    const fujiPos = bearingToPosition(bearing, AR_DISTANCE); 
    
    // ãƒ¢ãƒ‡ãƒ«ã‚³ãƒ³ãƒ†ãƒŠã®ä½ç½®ã‚’æ›´æ–°ã—ã€æ­£ã—ã„æ–¹è§’ã«è¡¨ç¤º
    if (fujisanContainer) {
        fujisanContainer.setAttribute('position', `${fujiPos.x} 0 ${fujiPos.z}`);
        
        // é è¿‘æ„Ÿã‚’å¼·èª¿ã™ã‚‹ãŸã‚ã®ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´ãƒ­ã‚¸ãƒƒã‚¯
        // å®Ÿéš›ã®è·é›¢ã¨AR_DISTANCEã‚’åŸºã«ã€ãƒ¢ãƒ‡ãƒ«ãŒé©åˆ‡ã«æ‹¡å¤§ç¸®å°ã•ã‚Œã‚‹ã‚ˆã†ã«èª¿æ•´
        // ã“ã“ã§ã®`distance`ã¯ç¾å®Ÿã®è·é›¢(km)ã€`AR_DISTANCE`ã¯ARç©ºé–“ã§ã®è¡¨ç¤ºè·é›¢(m)
        // èª¿æ•´ä¿‚æ•°ã‚’å¤§ããã—ã¦ã€ã‚ˆã‚Šå¤§ããªã‚¹ã‚±ãƒ¼ãƒ«ã§é è¿‘æ„Ÿã‚’å‡ºã™
        const baseScale = 0.05; // åŸºæº–ã¨ãªã‚‹ãƒ¢ãƒ‡ãƒ«ã®ç¸®å°º
        const scaleMultiplier = Math.min(2.0, distance / 50); // ç¾å®Ÿã®è·é›¢ã«å¿œã˜ã¦å¤§ããã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´
        const finalScale = baseScale * scaleMultiplier;

        fujiBody.setAttribute('scale', `${finalScale} ${finalScale} ${finalScale}`);
        fujiSnowcap.setAttribute('scale', `${finalScale} ${finalScale} ${finalScale}`);
        fujiLabel.setAttribute('scale', `${finalScale * 2} ${finalScale * 2} ${finalScale * 2}`); // ãƒ©ãƒ™ãƒ«ã¯ã•ã‚‰ã«å¤§ãã

    }
    
    // æƒ…å ±è¡¨ç¤ºã‚’æ›´æ–°
    infoDiv.innerHTML = ` 
        ğŸ—» <strong>å¯Œå£«å±±AR</strong><br> 
        <br> 
        ğŸ“ ç¾åœ¨åœ°<br> 
        ã€€ç·¯åº¦: ${userLat.toFixed(6)}<br> 
        ã€€çµŒåº¦: ${userLon.toFixed(6)}<br> 
        <br> 
        ğŸ¯ å¯Œå£«å±±<br> 
        ã€€è·é›¢: <strong>${distance.toFixed(1)}km</strong><br> 
        ã€€æ–¹è§’: <strong>${direction}</strong> (${bearing.toFixed(0)}Â°)<br> 
        <br> 
        ğŸ‘€ **å¯Œå£«å±±ã¯${direction}ã«ã‚ã‚Šã¾ã™**<br> 
        ã€€ãƒ‡ãƒã‚¤ã‚¹ã‚’${direction}ã«å‘ã‘ã¦æ¢ã—ã¦ãã ã•ã„ï¼ 
    `; 
} 

// --- ä½ç½®æƒ…å ±ã®ç›£è¦–ã¨åˆæœŸåŒ– (å¤‰æ›´ãªã—) ---
if (navigator.geolocation) { 
    navigator.geolocation.watchPosition( 
        (position) => { 
            userLat = position.coords.latitude; 
            userLon = position.coords.longitude; 
            updatePositions(); 
        }, 
        (error) => { 
            const errorMessage = (error.code === 1) ? "ä½ç½®æƒ…å ±ã®åˆ©ç”¨ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚" : `ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: ${error.code} - ${error.message}`;
            infoDiv.innerHTML = `âŒ ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼: ${errorMessage}<br><br>è¨­å®šã‹ã‚‰ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„`; 
            fujisanContainer.setAttribute('visible', false);
        },
        { 
            enableHighAccuracy: true, 
            maximumAge: 0, 
            timeout: 5000 
        } 
    ); 
} else {
    infoDiv.innerHTML = `
       ãƒ–ãƒ©ã‚¦ã‚¶ã‚¨ãƒ©ãƒ¼: Geolocation APIã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚
    `;
}

document.querySelector('a-scene').addEventListener('loaded', () => { 
    console.log('AR Scene loaded successfully'); 
    setTimeout(updatePositions, 1000); 
}); 

setInterval(updatePositions, 2000); 
</script> 

</body> 
</html>
