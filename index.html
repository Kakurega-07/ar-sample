<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>å¯Œå£«å±±AR</title>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
<style>
  #info {
    position: fixed;
    top: 7px;
    left: 7px;
    background: rgba(0,0,0,0.7); /* èƒŒæ™¯ã‚’å°‘ã—ä¸é€æ˜ã«ã—ã¦è¦‹ã‚„ã™ã */
    color: white;
    padding: 7px;
    font-family: sans-serif;
    font-size: 10px; /* ã‚µã‚¤ã‚ºã‚’å¤§ãã */
    z-index: 9999;
    border-radius: 5px;
    max-width: 80%;
  }
</style>
</head>
<body style="margin: 0; overflow: hidden;">

<div id="info">
  å¯Œå£«å±±AR<br>
  ä½ç½®æƒ…å ±å–å¾—ä¸­...
</div>

<a-scene 
    id="ar-scene"
    vr-mode-ui="enabled: false" 
    renderer="logarithmicDepthBuffer: true"
    arjs='sourceType: webcam; 
          sourceWidth:1280; sourceHeight:960; 
          displayWidth: 1280; displayHeight: 960;
          debugUIEnabled: false;' 
    device-orientation-permission-ui 
    loading-screen="enabled: false"
    embedded>
    
    <a-assets>
        <a-asset-item id="fujisan-model" src="./fuji.glb"></a-asset-item> 
    </a-assets>
    
    <a-entity light="type: ambient; color: #FFF; intensity: 0.8"></a-entity>
    <a-entity light="type: directional; color: #FFF; intensity: 0.7; castShadow: true" position="-2 3 1"></a-entity>
    <a-entity light="type: point; color: #ADD8E6; intensity: 0.2; castShadow: false" position="0 8 -20"></a-entity>

    <a-camera 
        id="camera"
        look-controls="enabled: true; magicWindowTrackingEnabled: true;"
        position="0 0 0">
    </a-camera>
    
    <a-entity id="fujisan-ar-container" position="0 0 0">
        <a-gltf-model
            id="fujisan-model-viewer"
            src="#fujisan-model"
            position="0 0 -100"       
            rotation="0 45 0"         
            scale="10 10 10"          
            shadow="receive: true; cast: true">
        </a-gltf-model>

        <a-text value="å¯Œå£«å±±" 
            position="0 35 -100" 
            align="center" 
            color="#E54C3C" 
            scale="100 100 100"> </a-text>

    </a-entity>
    
</a-scene>

<script>
const infoDiv = document.getElementById('info');
const fujisanContainer = document.getElementById('fujisan-ar-container');
// ğŸ—» ãƒ¢ãƒ‡ãƒ«ã®å‚ç…§ã‚’a-gltf-modelã«å¤‰æ›´
const fujisanModelViewer = document.getElementById('fujisan-model-viewer'); 
const fujiLabel = document.querySelector('a-text[value="å¯Œå£«å±±"]'); 

// å¯Œå£«å±±ã®ç¾å®Ÿã®åº§æ¨™ (å¤‰æ›´ãªã—)
const fujiLat = 35.360556; 
const fujiLon = 138.727778; 

let userLat = null; 
let userLon = null; 

// --- ã‚¸ã‚ªãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç®—é–¢æ•° (å¤‰æ›´ãªã—) ---
const R = 6371; // åœ°çƒã®åŠå¾„ (km)
function toRad(degrees) { return degrees * Math.PI / 180; }

function calcDistance(lat1, lon1, lat2, lon2) { 
    const dLat = toRad(lat2 - lat1); 
    const dLon = toRad(lon2 - lon1); 
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) + 
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
    return R * c; 
} 

function calcBearing(lat1, lon1, lat2, lon2) { 
    const dLon = toRad(lon2 - lon1); 
    const y = Math.sin(dLon) * Math.cos(toRad(lat2)); 
    const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) - 
              Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon); 
    const bearing = Math.atan2(y, x) * 180 / Math.PI; 
    return (bearing + 360) % 360; 
} 

function bearingToJapanese(bearing) { 
    const directions = ['åŒ—', 'åŒ—åŒ—æ±', 'åŒ—æ±', 'æ±åŒ—æ±', 'æ±', 'æ±å—æ±', 'å—æ±', 'å—å—æ±', 
                        'å—', 'å—å—è¥¿', 'å—è¥¿', 'è¥¿å—è¥¿', 'è¥¿', 'è¥¿åŒ—è¥¿', 'åŒ—è¥¿', 'åŒ—åŒ—è¥¿']; 
    const index = Math.round(bearing / 22.5) % 16; 
    return directions[index]; 
} 

function bearingToPosition(bearing, distance) { 
    const rad = toRad(bearing); 
    const x = Math.sin(rad) * distance; // æ±è¥¿æ–¹å‘ 
    const z = -Math.cos(rad) * distance; // å—åŒ—æ–¹å‘ï¼ˆ-ZãŒåŒ—ï¼‰ 
    return { x, z }; 
} 

// --- å¯Œå£«å±±ã¨ã‚³ãƒ³ãƒ‘ã‚¹ã®ä½ç½®ã‚’æ›´æ–° ---
function updatePositions() { 
    if (userLat === null || userLon === null) {
        infoDiv.innerHTML = `
             <strong>å¯Œå£«å±±AR</strong><br>
             ä½ç½®æƒ…å ±å–å¾—ä¸­...<br><br>
             **ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚** ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚„ãƒ‡ãƒã‚¤ã‚¹ã®GPSã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚
        `;
        fujisanContainer.setAttribute('visible', false);
        return; 
    }
    
    fujisanContainer.setAttribute('visible', true);

    const bearing = calcBearing(userLat, userLon, fujiLat, fujiLon); 
    const distance = calcDistance(userLat, userLon, fujiLat, fujiLon); 
    const direction = bearingToJapanese(bearing); 
    
    // ARç©ºé–“ä¸Šã§éå¸¸ã«é ãã«é…ç½®
    const AR_DISTANCE = 150; 
    const fujiPos = bearingToPosition(bearing, AR_DISTANCE); 
    
    // ãƒ¢ãƒ‡ãƒ«ã‚³ãƒ³ãƒ†ãƒŠã®ä½ç½®ã‚’æ›´æ–°
    if (fujisanContainer) {
        fujisanContainer.setAttribute('position', `${fujiPos.x} 0 ${fujiPos.z}`);
        
        // é è¿‘æ„Ÿã‚’å¼·èª¿ã™ã‚‹ãŸã‚ã®ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´ãƒ­ã‚¸ãƒƒã‚¯
        const baseRealDistanceKm = 90; 
        
        const scaleMultiplier = Math.max(0.01, Math.min(1.5, distance / baseRealDistanceKm)); 
        const finalScale = scaleMultiplier; 

        // ğŸ—» GLTFãƒ¢ãƒ‡ãƒ«ã«ã‚¹ã‚±ãƒ¼ãƒ«ã‚’é©ç”¨ (åˆæœŸå€¤ 10 10 10 ã«åˆã‚ã›ã¦10å€)
        fujisanModelViewer.setAttribute('scale', `${finalScale * 10} ${finalScale * 10} ${finalScale * 10}`);
        fujiLabel.setAttribute('scale', `${finalScale * 3} ${finalScale * 3} ${finalScale * 3}`);
    }
    
    // æƒ…å ±è¡¨ç¤ºã‚’æ›´æ–°
    infoDiv.innerHTML = ` 
        ğŸ—» <strong>å¯Œå£«å±±AR</strong><br> 
        <br> 
        ç¾åœ¨åœ°<br> 
        ã€€ç·¯åº¦: ${userLat.toFixed(6)}<br> 
        ã€€çµŒåº¦: ${userLon.toFixed(6)}<br> 
        <br> 
        å¯Œå£«å±±<br> 
        ã€€è·é›¢: <strong>${distance.toFixed(1)}km</strong><br> 
        ã€€æ–¹è§’: <strong>${direction}</strong> (${bearing.toFixed(0)}Â°)<br> 
        <br> 
        ã€€**å¯Œå£«å±±ã¯${direction}ã«ã‚ã‚Šã¾ã™**<br> 
        ã€€ãƒ‡ãƒã‚¤ã‚¹ã‚’${direction}ã«å‘ã‘ã¦æ¢ã—ã¦ãã ã•ã„ï¼ 
    `; 
} 

// --- ä½ç½®æƒ…å ±ã®ç›£è¦–ã¨åˆæœŸåŒ– (å¤‰æ›´ãªã—) ---
if (navigator.geolocation) { 
    navigator.geolocation.watchPosition( 
        (position) => { 
            userLat = position.coords.latitude; 
            userLon = position.coords.longitude; 
            updatePositions(); 
        }, 
        (error) => { 
            const errorMessage = (error.code === 1) ? "ä½ç½®æƒ…å ±ã®åˆ©ç”¨ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚" : `ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: ${error.code} - ${error.message}`;
            infoDiv.innerHTML = `ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼: ${errorMessage}<br><br>è¨­å®šã‹ã‚‰ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„`; 
            fujisanContainer.setAttribute('visible', false);
        },
        { 
            enableHighAccuracy: true, 
            maximumAge: 0, 
            timeout: 5000 
        } 
    ); 
} else {
    infoDiv.innerHTML = `
        ãƒ–ãƒ©ã‚¦ã‚¶ã‚¨ãƒ©ãƒ¼: Geolocation APIã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚
    `;
}

document.querySelector('a-scene').addEventListener('loaded', () => { 
    console.log('AR Scene loaded successfully'); 
    setTimeout(updatePositions, 1000); 
}); 

setInterval(updatePositions, 2000); 
</script> 

</body> 
</html>
